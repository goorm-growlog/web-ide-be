<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>ğŸŒ² WebSocket Tree í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            background: #f9f9f9;
            padding: 20px;
        }

        input {
            padding: 8px;
            margin-right: 10px;
            width: 400px;
        }

        button {
            padding: 10px 15px;
            margin: 5px 0;
        }

        pre {
            background: #fff;
            padding: 15px;
            border-radius: 6px;
            height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
<h2>ğŸŒ² WebSocket Tree í…ŒìŠ¤íŠ¸ (STOMP)</h2>

<div>
    ğŸ” JWT Token:<br/>
    <input id="tokenInput" placeholder="Bearer ey..." type="text"/><br/><br/>
    ğŸ“ Project ID:
    <input id="projectIdInput" placeholder="1" type="number"/>
    <button onclick="connectWebSocket()">WebSocket ì—°ê²°</button>
</div>

<pre id="log"></pre>

<script>
    let stompClient = null;

    function log(message) {
        const pre = document.getElementById("log");
        pre.textContent += `[${new Date().toLocaleTimeString()}] ${message}\n`;
        pre.scrollTop = pre.scrollHeight;
    }

    function connectWebSocket() {
        const token = document.getElementById("tokenInput").value.trim().replace(/^Bearer\s+/, '');
        const projectId = document.getElementById("projectIdInput").value.trim();

        if (!token || !projectId) {
            log("â— í† í°ê³¼ Project IDë¥¼ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
            return;
        }

        log("ğŸ“¡ WebSocket ì—°ê²° ì¤‘...");
        const socket = new WebSocket(`ws://localhost:8080/ws?token=${token}&projectId=${projectId}`);
        stompClient = Stomp.over(socket);
        stompClient.debug = str => log("ğŸ› " + str);

        stompClient.connect({}, () => {
            log("âœ… STOMP ì—°ê²° ì„±ê³µ");

            const topic = `/topic/projects/${projectId}/tree`;
            const destination = `/app/projects/${projectId}/tree/init`;

            stompClient.subscribe(topic, (msg) => {
                const body = JSON.parse(msg.body);
                log(`ğŸ“© ë©”ì‹œì§€ ìˆ˜ì‹  [${body.type}]`);

                switch (body.type) {
                    case 'tree:init':
                        log("ğŸŒ³ ì´ˆê¸° íŠ¸ë¦¬ êµ¬ì¡° ìˆ˜ì‹ !");
                        displayTree(body.payload);
                        break;
                    case 'tree:add':
                        log(`â• íŒŒì¼ ì¶”ê°€ë¨ â†’ ${JSON.stringify(body.payload)}`);
                        break;
                    case 'tree:remove':
                        log(`ğŸ—‘ï¸ íŒŒì¼ ì‚­ì œë¨ â†’ ${JSON.stringify(body.payload)}`);
                        break;
                    case 'tree:move':
                        log(`ğŸ”€ íŒŒì¼ ì´ë™ë¨ â†’ ${JSON.stringify(body.payload)}`);
                        break;
                    default:
                        log("ğŸ“¦ ê¸°íƒ€ ë©”ì‹œì§€:\n" + JSON.stringify(body, null, 2));
                }
            });

            log("ğŸ“¤ ì´ˆê¸° íŠ¸ë¦¬ ìš”ì²­ ì „ì†¡ ì¤‘...");
            stompClient.send(destination, {}, JSON.stringify({}));
        }, err => {
            log("âŒ STOMP ì—°ê²° ì‹¤íŒ¨: " + err);
        });
    }

    function displayTree(nodes, depth = 0) {
        const indent = '  '.repeat(depth);
        for (const node of nodes) {
            const icon = node.type === 'folder' ? 'ğŸ“' : 'ğŸ“„';
            log(`${indent}${icon} ${node.path || "(root)"}`);
            if (node.children && node.children.length > 0) {
                displayTree(node.children, depth + 1);
            }
        }
    }
</script>
</body>
</html>
