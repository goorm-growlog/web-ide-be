<!DOCTYPE html>
<html>
<head>
    <title>Unified Test Page (PTY Terminal & External Log Viewer)</title>
    <meta charset="UTF-8">
    <!-- xterm.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <link href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
    <!-- WebSocket ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 2em;
            background-color: #f8f9fa;
        }

        .container {
            max-width: 900px;
            margin: auto;
            background-color: white;
            padding: 2em;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .input-group {
            margin-bottom: 1em;
        }

        label {
            display: block;
            margin-bottom: 0.25em;
            font-weight: bold;
        }

        input[type="text"] {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            font-weight: bold;
        }

        button:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        button.primary {
            background-color: #007bff;
            color: white;
        }

        button.secondary {
            background-color: #6c757d;
            color: white;
        }

        #terminal-container {
            border: 1px solid #ccc;
            padding: 2px;
            border-radius: 4px;
            margin-top: 1em;
        }
    </style>
</head>
<body>
<div class="container">
    <h2>Unified Terminal & Log Viewer</h2>
    <p>ì´ í˜ì´ì§€ì—ì„œ PTY í„°ë¯¸ë„ì„ ì§ì ‘ ì‚¬ìš©í•˜ê³ , Swagger ë“± ì™¸ë¶€ì—ì„œ ì‹¤í–‰í•œ ì‘ì—…ì˜ ë¡œê·¸ë„ í•¨ê»˜ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

    <div class="input-group">
        <label for="jwtToken">JWT Access Token:</label>
        <input id="jwtToken" placeholder="ë¡œê·¸ì¸ í›„ Access Token ì…ë ¥" type="text">
    </div>
    <div class="input-group">
        <label for="projectId">Project ID:</label>
        <input id="projectId" type="text" value="1">
    </div>
    <div>
        <button class="primary" id="connectBtn" onclick="connectAndStart()">Connect & Start Terminal</button>
        <button class="secondary" disabled id="disconnectBtn" onclick="disconnect()">Disconnect</button>
    </div>
    <div id="terminal-container"></div>
</div>

<script>
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const terminalContainer = document.getElementById('terminal-container');

    let stompClient = null;
    let term = null;
    let terminalContainerId = null; // ì´ í˜ì´ì§€ì—ì„œ ì‹œì‘í•œ í„°ë¯¸ë„ ì„¸ì…˜ì˜ ì»¨í…Œì´ë„ˆ ID

    function connectAndStart() {
        const jwtToken = document.getElementById('jwtToken').value;
        const projectId = document.getElementById('projectId').value;

        if (!jwtToken || !projectId) {
            alert("JWT Tokenê³¼ Project IDë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        // 1. xterm.js í„°ë¯¸ë„ ìƒì„± (ìµœì´ˆ í•œ ë²ˆë§Œ)
        if (!term) {
            term = new Terminal({cursorBlink: true, rows: 25});
            term.open(terminalContainer);
            // ì‚¬ìš©ìê°€ í„°ë¯¸ë„ì— ì…ë ¥í•˜ëŠ” ëª¨ë“  í‚¤ë¥¼ ì„œë²„ë¡œ ì „ì†¡
            term.onData(data => {
                if (stompClient && stompClient.connected && terminalContainerId) {
                    stompClient.send("/app/terminal/command", {}, data);
                }
            });
        }
        term.reset(); // ì´ì „ ë‚´ìš© ì§€ìš°ê¸°
        term.write("ğŸ”Œ Connecting to WebSocket...\r\n");

        // 2. WebSocket ì—°ê²°
        const socket = new SockJS('http://localhost:8080/ws');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        const headers = {'Authorization': 'Bearer ' + jwtToken};
        stompClient.connect(headers, onConnected, onError);
    }

    function onConnected() {
        term.write("âœ… STOMP Connected!\r\n");
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;

        // 3. PTY ì„¸ì…˜ ì‹œì‘ ìš”ì²­ (ê°€ì¥ ì¤‘ìš”)
        const projectId = document.getElementById('projectId').value;
        stompClient.send("/app/terminal/start", {}, JSON.stringify({projectId: parseInt(projectId)}));
        term.write("ğŸš€ Requesting PTY session...\r\n");

        // 4. ëª¨ë“  ë¡œê·¸ë¥¼ ìˆ˜ì‹ í•  ê°œì¸ ì±„ë„ì„ ë¯¸ë¦¬ êµ¬ë…
        stompClient.subscribe('/user/queue/logs', onMessageReceived);

        const queueUrl = `/user/queue/termination`;

        stompClient.subscribe(queueUrl, function (message) {
            console.log("RAW MESSAGE RECEIVED: ", message.body);
            const body = JSON.parse(message.body);
            if (body.type === 'SESSION_TERMINATE') {
                console.log(`SESSION TERMINATED: ${message.body}`);
                alert(`The server has closed your session: ${message.body}`);
                disconnect(); // ë©”ì‹œì§€ ìˆ˜ì‹  í›„ ì—°ê²° í•´ì œ
            }
            if (body.type === 'PROJECT_DELETED') {
                console.log(`PROJECT DELETION NOTICE: ${message.body}`)
                alert(`Server Message: ${message.body}`)
            }
        });
        console.log(`Subscribed to ${queueUrl} for server-sent messages.`);
    }

    function onMessageReceived(message) {
        const logMessage = JSON.parse(message.body);

        // ì²˜ìŒ ë¡œê·¸ë¥¼ ë°›ì„ ë•Œ, ì´ í„°ë¯¸ë„ì´ ì–´ë–¤ ì»¨í…Œì´ë„ˆì— ì—°ê²°ë˜ì—ˆëŠ”ì§€ IDë¥¼ ì €ì¥
        if (!terminalContainerId) {
            terminalContainerId = logMessage.targetId;
            term.write(`\x1b[32mâœ… Terminal connected to container: ${terminalContainerId.substring(0, 12)}\x1b[0m\r\n`);
        }

        // ì´ í„°ë¯¸ë„ ì„¸ì…˜ì— í•´ë‹¹í•˜ëŠ” ë¡œê·¸ëŠ” ê·¸ëŒ€ë¡œ ì¶œë ¥
        if (logMessage.targetId === terminalContainerId) {
            term.write(logMessage.content);
        } else {
            // ì½”ë“œ ì‹¤í–‰ ë“± ë‹¤ë¥¸ ë¡œê·¸ëŠ” ì ‘ë‘ì‚¬ë¥¼ ë¶™ì—¬ì„œ ì¶œë ¥ (í„°ë¯¸ë„ê³¼ êµ¬ë¶„)
            const prefix = `\r\n\x1b[36m[External Log | Target: ${logMessage.targetId.substring(0, 8)}]\x1b[0m `;
            const formattedContent = logMessage.content.replace(/\n/g, '\r\n');
            term.write(prefix + formattedContent);
        }
    }

    function onError(error) {
        if (term) {
            term.write("âŒ STOMP Connection Error: " + error + "\r\n");
        }
        disconnect();
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect(() => {
                if (term) {
                    term.write("\r\nğŸ”Œ STOMP Disconnected.\r\n");
                }
            });
        }
        connectBtn.disabled = false;
        disconnectBtn.disabled = true;
        stompClient = null;
        terminalContainerId = null;
    }
</script>
</body>
</html>
