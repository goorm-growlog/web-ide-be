name: Web IDE Backend CI/CD

on:
  push:
    branches: [ main ]  # main ë¸Œëœì¹˜ì— push(=ë¨¸ì§€ í¬í•¨)ë˜ì—ˆì„ ë•Œ ì‹¤í–‰ë¨

env:
  AWS_REGION: ap-northeast-2
  EC2_HOST: ${{ secrets.EC2_HOST }}         # EC2 í¼ë¸”ë¦­ IP ì£¼ì†Œ (Secretsì— ë“±ë¡)
  EC2_USER: ubuntu                          # EC2 ì‚¬ìš©ì ê³„ì •ëª… (ë³´í†µ ubuntu)
  PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}   # EC2 ì ‘ì†ìš© .pem í‚¤ ë‚´ìš© (Secretsì— í…ìŠ¤íŠ¸ë¡œ ë“±ë¡)
  BACKEND_IMAGE: webide-backend             # Docker ì´ë¯¸ì§€ ì´ë¦„ (íƒœê·¸ í¬í•¨ X)
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}  # Docker Hub ê³„ì •
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}  # Docker Hub ë¹„ë°€ë²ˆí˜¸ or Access Token

jobs:
  deploy:
    runs-on: ubuntu-latest  # GitHubê°€ ì œê³µí•˜ëŠ” ìµœì‹  ìš°ë¶„íˆ¬ í™˜ê²½ì—ì„œ ì‹¤í–‰

    steps:
      # 1. GitHub ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ”„ Checkout source code
        uses: actions/checkout@v3  # ë¦¬í¬ì§€í† ë¦¬ì˜ ì½”ë“œë¥¼ ì›Œí¬í”Œë¡œìš° í™˜ê²½ì— ë‹¤ìš´ë¡œë“œ

      # 2. JDK 21 ì„¤ì¹˜ (Spring ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œì— í•„ìš”)
      - name: â˜• JDK 21 ì„¤ì¹˜
        uses: actions/setup-java@v3
        with:
          java-version: '21'       # ì‚¬ìš© ì¤‘ì¸ Java ë²„ì „
          distribution: 'temurin'  # OpenJDK ë°°í¬íŒ ì¤‘ í•˜ë‚˜ (ê°€ì¥ ë§ì´ ì‚¬ìš©)

      # 3. Gradle ë¹Œë“œ (ì½”ë“œ ê²€ì¦, ì‹¤íŒ¨ ì‹œ Docker ë¹Œë“œ & ë°°í¬ ì¤‘ë‹¨)
      - name: ğŸ§ª Gradle Build (ì‚¬ì „ í™•ì¸ìš©)
        run: ./gradlew build       # build = compile + testê¹Œì§€ í¬í•¨ë¨

      # 4. Docker Hub ë¡œê·¸ì¸
      - name: ğŸ” Docker Hub ë¡œê·¸ì¸
        run: echo "${{ env.DOCKER_PASSWORD }}" | docker login -u "${{ env.DOCKER_USERNAME }}" --password-stdin

      # 5. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Push
      - name: ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Push
        run: |
          docker build -t $DOCKER_USERNAME/$BACKEND_IMAGE:latest -f Dockerfile .  # ì´ë¯¸ì§€ ë¹Œë“œ
          docker push $DOCKER_USERNAME/$BACKEND_IMAGE:latest                      # Docker Hubë¡œ í‘¸ì‹œ

      # 6. EC2ì— SSHë¡œ ì ‘ì†í•´ì„œ ì»¨í…Œì´ë„ˆ ë°°í¬ (í˜„ì¬ ì£¼ì„ ì²˜ë¦¬ë¨)
      - name: ğŸš€ EC2 ë°°í¬ (ì»¨í…Œì´ë„ˆ êµì²´)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ env.PRIVATE_KEY }}
          script: |
            docker pull $DOCKER_USERNAME/$BACKEND_IMAGE:latest
            docker stop webide-backend || true
            docker rm webide-backend || true
            docker run -d --name webide-backend -p 8080:8080 $DOCKER_USERNAME/$BACKEND_IMAGE:latest
