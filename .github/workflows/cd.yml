name: Web IDE Backend CI/CD

on:
  push:
    branches: [ main ]  # main ë¸Œëœì¹˜ì— push(=ë¨¸ì§€ í¬í•¨)ë˜ì—ˆì„ ë•Œ ì‹¤í–‰ë¨
  workflow_dispatch:  # ğŸ‘ˆ ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥í•˜ê²Œ ì¶”ê°€

env:
  AWS_REGION: ap-northeast-2
  EC2_HOST: ${{ secrets.EC2_HOST }}         # EC2 í¼ë¸”ë¦­ IP ì£¼ì†Œ (Secretsì— ë“±ë¡)
  EC2_USER: ubuntu                          # EC2 ì‚¬ìš©ì ê³„ì •ëª… (ë³´í†µ ubuntu)
  PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}   # EC2 ì ‘ì†ìš© .pem í‚¤ ë‚´ìš© (Secretsì— í…ìŠ¤íŠ¸ë¡œ ë“±ë¡)
  BACKEND_IMAGE: webide-backend             # Docker ì´ë¯¸ì§€ ì´ë¦„ (íƒœê·¸ í¬í•¨ X)
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}  # Docker Hub ê³„ì •
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}  # Docker Hub ë¹„ë°€ë²ˆí˜¸ or Access Token

jobs:
  deploy:
    runs-on: ubuntu-latest  # GitHubê°€ ì œê³µí•˜ëŠ” ìµœì‹  ìš°ë¶„íˆ¬ í™˜ê²½ì—ì„œ ì‹¤í–‰

    steps:
      #  GitHub ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ”„ Checkout source code
        uses: actions/checkout@v3  # ë¦¬í¬ì§€í† ë¦¬ì˜ ì½”ë“œë¥¼ ì›Œí¬í”Œë¡œìš° í™˜ê²½ì— ë‹¤ìš´ë¡œë“œ

      #  JDK 21 ì„¤ì¹˜ (Spring ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œì— í•„ìš”)
      - name: â˜• JDK 21 ì„¤ì¹˜
        uses: actions/setup-java@v3
        with:
          java-version: '21'       # ì‚¬ìš© ì¤‘ì¸ Java ë²„ì „
          distribution: 'temurin'  # OpenJDK ë°°í¬íŒ ì¤‘ í•˜ë‚˜ (ê°€ì¥ ë§ì´ ì‚¬ìš©)

      # ğŸ“¦ .env íŒŒì¼ ìë™ ìƒì„±
      - name: ğŸ“¦ .env íŒŒì¼ ìƒì„±
        run: |
          echo "DB_HOST=${{ secrets.DB_HOST }}" >> .env
          echo "DB_NAME=webide" >> .env
          echo "DB_USER_NAME=${{ secrets.DB_USER_NAME }}" >> .env
          echo "DB_USER_PASSWORD=${{ secrets.DB_USER_PASSWORD }}" >> .env
          echo "DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}" >> .env

          echo "RDS_ENDPOINT=${{ secrets.RDS_ENDPOINT }}" >> .env
          echo "RDS_DB_NAME=webide_database" >> .env
          echo "RDS_DB_USER_NAME=${{ secrets.RDS_DB_USER_NAME }}" >> .env
          echo "RDS_DB_PASSWORD=${{ secrets.RDS_DB_PASSWORD }}" >> .env

          echo "ACCESS_KEY=${{ secrets.ACCESS_KEY }}" >> .env
          echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
          echo "S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}" >> .env
          echo "S3_REGION=ap-northeast-2" >> .env
          echo "IMAGE_UPLOAD_DIR=profile-images/" >> .env
          echo "DEFAULT_PROFILE_IMAGE_URL=https://${{ secrets.S3_BUCKET_NAME }}.s3.amazonaws.com/profile-images/default.png" >> .env

          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "JWT_EXPIRATION=3600000" >> .env
          echo "REFRESH_SECRET=${{ secrets.REFRESH_SECRET }}" >> .env
          echo "REFRESH_EXPIRATION=604800" >> .env

          echo "MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}" >> .env
          echo "MAIL_PASSWORD=\"${{ secrets.MAIL_PASSWORD }}\"" >> .env
          echo "MAIL_FROM=${{ secrets.MAIL_FROM }}" >> .env

          echo "LIVEBLOCKS_ROOM_SALT=${{ secrets.LIVEBLOCKS_ROOM_SALT }}" >> .env
          echo "LIVEBLOCKS_SECRET_KEY=${{ secrets.LIVEBLOCKS_SECRET_KEY }}" >> .env

          echo "TEMPLATE_DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}" >> .env

          echo "SPRING_PROFILES_ACTIVE=prod" >> .env

          echo "REDIS_HOST=${{ secrets.REDIS_HOST }}" >> .env
          echo "REDIS_PORT=${{ secrets.REDIS_PORT }}" >> .env
          echo "REDIS_USERNAME=${{ secrets.REDIS_USERNAME }}" >> .env
          echo "REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}" >> .env

      - name: ğŸ” ë””ë²„ê¹… .env ì¤„ ë²ˆí˜¸ í™•ì¸
        run: cat -n .env

      #  Gradle ë¹Œë“œ (ì½”ë“œ ê²€ì¦, ì‹¤íŒ¨ ì‹œ Docker ë¹Œë“œ & ë°°í¬ ì¤‘ë‹¨)
      - name: ğŸ§ª Gradle Build (ì‚¬ì „ í™•ì¸ìš©)
        run: |
          set -a
          source .env
          set +a
          ./gradlew clean bootJar       # build = compile

      # Docker Hub ë¡œê·¸ì¸
      - name: ğŸ” Docker Hub ë¡œê·¸ì¸
        run: echo "${{ env.DOCKER_PASSWORD }}" | docker login -u "${{ env.DOCKER_USERNAME }}" --password-stdin


      # ğŸ“‚ .env íŒŒì¼ EC2ì— ì „ì†¡
      - name: ğŸ“‚ EC2ì— .env ì „ì†¡
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ env.PRIVATE_KEY }}
          source: ".env"
          target: "/home/ubuntu/web-ide-be"

      #  Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Push
      - name: ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Push
        run: |
          docker build --no-cache -t $DOCKER_USERNAME/$BACKEND_IMAGE:latest \
          -f main-server/Dockerfile main-server                                   # ì´ë¯¸ì§€ ë¹Œë“œ
          docker push $DOCKER_USERNAME/$BACKEND_IMAGE:latest                      # Docker Hubë¡œ í‘¸ì‹œ


      # ëª¨ë“  í…œí”Œë¦¿ ì´ë¯¸ì§€ ë¹Œë“œ & Push
      - name: ğŸ§© í…œí”Œë¦¿ ì´ë¯¸ì§€ ë¹Œë“œ ë° Docker Hub Push
        run: |
          for dir in infra/templates/*; do
            name=$(basename "$dir")             # ex: java-17
            lang="${name%%-*}"                  # java
            version="${name##*-}"               # 17
            tag="$DOCKER_USERNAME/${lang}-template:${version}"
            echo "ğŸ‘‰ Building and pushing $tag"
            docker build -t "$tag" "$dir"
            docker push "$tag"
          done

      # EC2ì— SSHë¡œ ì ‘ì†í•´ì„œ ì»¨í…Œì´ë„ˆ ë°°í¬
      - name: ğŸš€ EC2 ë°°í¬ (ì»¨í…Œì´ë„ˆ êµì²´)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ env.PRIVATE_KEY }}
          envs: DOCKER_USERNAME,BACKEND_IMAGE
          script: |
            # ìµœì‹  ì´ë¯¸ì§€ pull
            docker pull $DOCKER_USERNAME/$BACKEND_IMAGE:latest

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            docker stop webide-backend || true
            docker rm webide-backend || true

            # âœ… í™˜ê²½ë³€ìˆ˜ í™•ì¸ ë¡œê·¸ ì¶œë ¥
            echo "âœ… .env íŒŒì¼ ì ìš© ì™„ë£Œ"

            # ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            docker-compose up -d

            # í…œí”Œë¦¿ ì´ë¯¸ì§€ ë¯¸ë¦¬ pull (ì„ íƒ ì‚¬í•­, ìë™ pullë„ ë˜ê¸´ í•¨)
            docker pull $DOCKER_USERNAME/java-template:17 || true
            docker pull $DOCKER_USERNAME/python-template:3.11 || true

