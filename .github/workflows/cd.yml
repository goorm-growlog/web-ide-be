name: Web IDE Backend CI/CD

on:
  push:
    branches: [ main ]  # main ë¸Œëœì¹˜ì— push(=ë¨¸ì§€ í¬í•¨)ë˜ì—ˆì„ ë•Œ ì‹¤í–‰ë¨
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}  # Docker Hub ê³„ì •
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}  # Docker Hub ë¹„ë°€ë²ˆí˜¸ or Access Token

jobs:
  deploy-main-server:
    name: Deploy Main Server
    runs-on: ubuntu-latest  # GitHubê°€ ì œê³µí•˜ëŠ” ìµœì‹  ìš°ë¶„íˆ¬ í™˜ê²½ì—ì„œ ì‹¤í–‰
    env:
      # [ìœ ì§€] ê¸°ì¡´ í™˜ê²½ë³€ìˆ˜ëŠ” Main Serverìš©ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ubuntu
      PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
      BACKEND_IMAGE: webide-main-server # Main Server ì „ìš© ì´ë¯¸ì§€ ì´ë¦„

    steps:
      #  GitHub ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ”„ Checkout source code
        uses: actions/checkout@v3  # ë¦¬í¬ì§€í† ë¦¬ì˜ ì½”ë“œë¥¼ ì›Œí¬í”Œë¡œìš° í™˜ê²½ì— ë‹¤ìš´ë¡œë“œ

      #  JDK 21 ì„¤ì¹˜ (Spring ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œì— í•„ìš”)
      - name: â˜• JDK 21 ì„¤ì¹˜
        uses: actions/setup-java@v3
        with:
          java-version: '21'       # ì‚¬ìš© ì¤‘ì¸ Java ë²„ì „
          distribution: 'temurin'  # OpenJDK ë°°í¬íŒ ì¤‘ í•˜ë‚˜ (ê°€ì¥ ë§ì´ ì‚¬ìš©)

      # ğŸ“¦ .env íŒŒì¼ ìë™ ìƒì„±
      - name: ğŸ“¦ .env íŒŒì¼ ìƒì„±
        run: |
          # Main Serverì— í•„ìš”í•œ í™˜ê²½ë³€ìˆ˜ë§Œ ìƒì„±í•©ë‹ˆë‹¤.
          echo "SPRING_PROFILES_ACTIVE=prod" >> main-server.env
          echo "SERVER_ID=${{ secrets.SERVER_ID }}" >> main-server.env
          echo "RDS_ENDPOINT=${{ secrets.RDS_ENDPOINT }}" >> main-server.env
          echo "RDS_DB_NAME=webide_database" >> main-server.env
          echo "RDS_DB_USER_NAME=${{ secrets.RDS_DB_USER_NAME }}" >> main-server.env
          echo "RDS_DB_PASSWORD=${{ secrets.RDS_DB_PASSWORD }}" >> main-server.env

          echo "ACCESS_KEY=${{ secrets.ACCESS_KEY }}" >> main-server.env
          echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> main-server.env
          echo "S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}" >> main-server.env
          echo "S3_REGION=ap-northeast-2" >> main-server.env
          echo "IMAGE_UPLOAD_DIR=profile-images/" >> main-server.env
          echo "DEFAULT_PROFILE_IMAGE_URL=https://${{ secrets.S3_BUCKET_NAME }}.s3.amazonaws.com/profile-images/default.png" >> main-server.env

          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> main-server.env
          echo "JWT_EXPIRATION=3600000" >> main-server.env
          echo "REFRESH_SECRET=${{ secrets.REFRESH_SECRET }}" >> main-server.env
          echo "REFRESH_EXPIRATION=604800" >> main-server.env

          echo "MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}" >> main-server.env
          echo "MAIL_PASSWORD=\"${{ secrets.MAIL_PASSWORD }}\"" >> main-server.env
          echo "MAIL_FROM=${{ secrets.MAIL_FROM }}" >> main-server.env

          echo "LIVEBLOCKS_SECRET_KEY=${{ secrets.LIVEBLOCKS_SECRET_KEY }}" >> main-server.env
          echo "LIVEBLOCKS_ROOM_SALT=${{ secrets.LIVEBLOCKS_ROOM_SALT }}" >> main-server.env
          echo "TEMPLATE_DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}" >> main-server.env

          echo "REDIS_HOST=${{ secrets.REDIS_HOST }}" >> main-server.env
          echo "REDIS_PORT=${{ secrets.REDIS_PORT }}" >> main-server.env
          echo "REDIS_USERNAME=${{ secrets.REDIS_USERNAME }}" >> main-server.env
          echo "REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}" >> main-server.env

          echo "KAKAO_REST_API_KEY=${{ secrets.KAKAO_REST_API_KEY }}" >> main-server.env
          echo "KAKAO_REDIRECT_URI=${{ secrets.KAKAO_REDIRECT_URI }}" >> main-server.env
          echo "KAKAO_REDIRECT_URI_LOCAL=${{ secrets.KAKAO_REDIRECT_URI_LOCAL }}" >> main-server.env

          echo "RABBITMQ_HOST=rabbitmq" >> main-server.env
          echo "RABBITMQ_USER=${{ secrets.RABBITMQ_USER }}" >> main-server.env
          echo "RABBITMQ_PASS=${{ secrets.RABBITMQ_PASS }}" >> main-server.env

      - name: ğŸ§ª Gradle Build
        run: ./gradlew clean bootJar

      - name: ğŸ” Docker Hub ë¡œê·¸ì¸
        run: echo "${{ env.DOCKER_PASSWORD }}" | docker login -u "${{ env.DOCKER_USERNAME }}" --password-stdin

      - name: ğŸ³ Build and Push main-server image
        run: |
          docker build --no-cache -t $DOCKER_USERNAME/$BACKEND_IMAGE:latest \
          -f main-server/Dockerfile main-server
          docker push $DOCKER_USERNAME/$BACKEND_IMAGE:latest

      - name: ğŸ“‚ SCP .env to main-server EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ env.PRIVATE_KEY }}
          source: "main-server.env"
          target: "/home/ubuntu/web-ide-be/.env"

      - name: ğŸš€ Deploy to main-server EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ env.PRIVATE_KEY }}
          envs: DOCKER_USERNAME,BACKEND_IMAGE
          script: |
            echo "### ğŸ§¹ [ìš©ëŸ‰ í™•ë³´] ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” Docker ë¦¬ì†ŒìŠ¤ë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤..."
            docker system prune -af --volumes

            echo "### ğŸšš ìµœì‹  ì´ë¯¸ì§€ë¥¼ pull í•©ë‹ˆë‹¤..."
            docker pull $DOCKER_USERNAME/$BACKEND_IMAGE:latest

            echo "### ğŸš€ main-server ì»¨í…Œì´ë„ˆë¥¼ ì¬ì‹œì‘í•©ë‹ˆë‹¤..."
            cd /home/ubuntu/web-ide-be
            docker-compose up -d --force-recreate main-server

  deploy-worker-server:
    name: Deploy Worker Server
    runs-on: ubuntu-latest
    env:
      # [ì‹ ê·œ] Worker Server ì „ìš© í™˜ê²½ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
      WORKER_EC2_HOST: ${{ secrets.WORKER_EC2_HOST }}
      EC2_USER: ubuntu
      PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
      BACKEND_IMAGE: webide-worker-server

    steps:
      - name: ğŸ”„ Checkout source code
        uses: actions/checkout@v3

      - name: â˜• JDK 21 ì„¤ì¹˜
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ğŸ“¦ Create .env for worker-server
        run: |
          # Worker Serverì— í•„ìš”í•œ í™˜ê²½ë³€ìˆ˜ë§Œ ìƒì„±í•©ë‹ˆë‹¤.
          echo "SPRING_PROFILES_ACTIVE=prod" >> worker-server.env
          echo "RABBITMQ_HOST=${{ secrets.MAIN_SERVER_PRIVATE_IP }}" >> worker-server.env
          echo "RABBITMQ_USER=${{ secrets.RABBITMQ_USER }}" >> worker-server.env
          echo "RABBITMQ_PASS=${{ secrets.RABBITMQ_PASS }}" >> worker-server.env

      - name: ğŸ§ª Gradle Build
        run: ./gradlew clean bootJar

      - name: ğŸ” Docker Hub ë¡œê·¸ì¸
        run: echo "${{ env.DOCKER_PASSWORD }}" | docker login -u "${{ env.DOCKER_USERNAME }}" --password-stdin

      - name: ğŸ³ Build and Push worker-server image
        run: |
          docker build --no-cache -t $DOCKER_USERNAME/$BACKEND_IMAGE:latest \
          -f worker-server/Dockerfile worker-server
          docker push $DOCKER_USERNAME/$BACKEND_IMAGE:latest

      - name: ğŸ“‚ SCP .env to worker-server EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ env.WORKER_EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ env.PRIVATE_KEY }}
          source: "worker-server.env"
          target: "/home/ubuntu/web-ide-worker/.env"

      - name: ğŸš€ Deploy to worker-server EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.WORKER_EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ env.PRIVATE_KEY }}
          envs: DOCKER_USERNAME,BACKEND_IMAGE
          script: |
            echo "### ğŸ§¹ [ìš©ëŸ‰ í™•ë³´] ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” Docker ë¦¬ì†ŒìŠ¤ë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤..."
            docker system prune -af --volumes

            echo "### ğŸšš ìµœì‹  ì´ë¯¸ì§€ë¥¼ pull í•©ë‹ˆë‹¤..."
            docker pull $DOCKER_USERNAME/$BACKEND_IMAGE:latest

            echo "### ğŸš€ worker-server ì»¨í…Œì´ë„ˆë¥¼ ì¬ì‹œì‘í•©ë‹ˆë‹¤..."
            cd /home/ubuntu/web-ide-worker
            docker-compose up -d --force-recreate worker-server

            echo "### âš¡ï¸ [ì„±ëŠ¥ ìµœì í™”] ìì£¼ ì‚¬ìš©í•˜ëŠ” í…œí”Œë¦¿ ì´ë¯¸ì§€ë¥¼ ë¯¸ë¦¬ pull í•©ë‹ˆë‹¤..."
            docker pull ${{ env.DOCKER_USERNAME }}/java-template:17 || true
            docker pull ${{ env.DOCKER_USERNAME }}/python-template:3.11 || true
            echo "### âœ… í…œí”Œë¦¿ ì´ë¯¸ì§€ pull ì™„ë£Œ."
