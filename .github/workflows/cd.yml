name: Web IDE Backend CI/CD

on:
  push:
    branches: [ main ]  # main ë¸Œëœì¹˜ì— push(=ë¨¸ì§€ í¬í•¨)ë˜ì—ˆì„ ë•Œ ì‹¤í–‰ë¨
  workflow_dispatch:  # ğŸ‘ˆ ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥í•˜ê²Œ ì¶”ê°€

env:
  AWS_REGION: ap-northeast-2
  EC2_HOST: ${{ secrets.EC2_HOST }}         # EC2 í¼ë¸”ë¦­ IP ì£¼ì†Œ (Secretsì— ë“±ë¡)
  EC2_USER: ubuntu                          # EC2 ì‚¬ìš©ì ê³„ì •ëª… (ë³´í†µ ubuntu)
  PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}   # EC2 ì ‘ì†ìš© .pem í‚¤ ë‚´ìš© (Secretsì— í…ìŠ¤íŠ¸ë¡œ ë“±ë¡)
  BACKEND_IMAGE: webide-backend             # Docker ì´ë¯¸ì§€ ì´ë¦„ (íƒœê·¸ í¬í•¨ X)
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}  # Docker Hub ê³„ì •
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}  # Docker Hub ë¹„ë°€ë²ˆí˜¸ or Access Token

jobs:
  deploy:
    runs-on: ubuntu-latest  # GitHubê°€ ì œê³µí•˜ëŠ” ìµœì‹  ìš°ë¶„íˆ¬ í™˜ê²½ì—ì„œ ì‹¤í–‰

    steps:
      #  GitHub ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ”„ Checkout source code
        uses: actions/checkout@v3  # ë¦¬í¬ì§€í† ë¦¬ì˜ ì½”ë“œë¥¼ ì›Œí¬í”Œë¡œìš° í™˜ê²½ì— ë‹¤ìš´ë¡œë“œ

      #  JDK 21 ì„¤ì¹˜ (Spring ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œì— í•„ìš”)
      - name: â˜• JDK 21 ì„¤ì¹˜
        uses: actions/setup-java@v3
        with:
          java-version: '21'       # ì‚¬ìš© ì¤‘ì¸ Java ë²„ì „
          distribution: 'temurin'  # OpenJDK ë°°í¬íŒ ì¤‘ í•˜ë‚˜ (ê°€ì¥ ë§ì´ ì‚¬ìš©)

      #  Gradle ë¹Œë“œ (ì½”ë“œ ê²€ì¦, ì‹¤íŒ¨ ì‹œ Docker ë¹Œë“œ & ë°°í¬ ì¤‘ë‹¨)
      - name: ğŸ§ª Gradle Build (ì‚¬ì „ í™•ì¸ìš©)
        run: ./gradlew build       # build = compile + testê¹Œì§€ í¬í•¨ë¨

      # Docker Hub ë¡œê·¸ì¸
      - name: ğŸ” Docker Hub ë¡œê·¸ì¸
        run: echo "${{ env.DOCKER_PASSWORD }}" | docker login -u "${{ env.DOCKER_USERNAME }}" --password-stdin

      # ğŸ“¦ .env íŒŒì¼ ìë™ ìƒì„± (.env.template ê¸°ë°˜)
      - name: ğŸ“¦ .env íŒŒì¼ ìƒì„±
        run: |
          cp .env.template .env
          sed -i "s|\${DB_USER_NAME}|${{ secrets.DB_USER_NAME }}|g" .env
          sed -i "s|\${DB_USER_PASSWORD}|${{ secrets.DB_USER_PASSWORD }}|g" .env
          sed -i "s|\${DB_ROOT_PASSWORD}|${{ secrets.DB_ROOT_PASSWORD }}|g" .env
          sed -i "s|\${ACCESS_KEY}|${{ secrets.ACCESS_KEY }}|g" .env
          sed -i "s|\${SECRET_KEY}|${{ secrets.SECRET_KEY }}|g" .env
          sed -i "s|\${S3_BUCKET_NAME}|${{ secrets.S3_BUCKET_NAME }}|g" .env
          sed -i "s|\${JWT_SECRET}|${{ secrets.JWT_SECRET }}|g" .env
          sed -i "s|\${MAIL_USERNAME}|${{ secrets.MAIL_USERNAME }}|g" .env
          sed -i "s|\${MAIL_PASSWORD}|${{ secrets.MAIL_PASSWORD }}|g" .env
          sed -i "s|\${MAIL_FROM}|${{ secrets.MAIL_FROM }}|g" .env
          sed -i "s|\${LIVEBLOCKS_ROOM_SALT}|${{ secrets.LIVEBLOCKS_ROOM_SALT }}|g" .env
          sed -i "s|\${LIVEBLOCKS_SECRET_KEY}|${{ secrets.LIVEBLOCKS_SECRET_KEY }}|g" .env
          sed -i "s|\${DOCKER_USERNAME}|${{ secrets.DOCKER_USERNAME }}|g" .env

      # ğŸ“‚ .env íŒŒì¼ EC2ì— ì „ì†¡
      - name: ğŸ“‚ EC2ì— .env ì „ì†¡
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ env.PRIVATE_KEY }}
          source: ".env"
          target: "/home/ubuntu/web-ide-be"

      #  Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Push
      - name: ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Push
        run: |
          docker build -t $DOCKER_USERNAME/$BACKEND_IMAGE:latest -f Dockerfile .  # ì´ë¯¸ì§€ ë¹Œë“œ
          docker push $DOCKER_USERNAME/$BACKEND_IMAGE:latest                      # Docker Hubë¡œ í‘¸ì‹œ

      # ëª¨ë“  í…œí”Œë¦¿ ì´ë¯¸ì§€ ë¹Œë“œ & Push
      - name: ğŸ§© í…œí”Œë¦¿ ì´ë¯¸ì§€ ë¹Œë“œ ë° Docker Hub Push
        run: |
          for dir in infra/templates/*; do
            name=$(basename "$dir")             # ex: java-17
            lang="${name%%-*}"                  # java
            version="${name##*-}"               # 17
            tag="$DOCKER_USERNAME/${lang}-template:${version}"
            echo "ğŸ‘‰ Building and pushing $tag"
            docker build -t "$tag" "$dir"
            docker push "$tag"
          done

      # EC2ì— SSHë¡œ ì ‘ì†í•´ì„œ ì»¨í…Œì´ë„ˆ ë°°í¬
      - name: ğŸš€ EC2 ë°°í¬ (ì»¨í…Œì´ë„ˆ êµì²´)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ env.PRIVATE_KEY }}
          envs: DOCKER_USERNAME,BACKEND_IMAGE
          script: |
            # ìµœì‹  ì´ë¯¸ì§€ pull
            docker pull $DOCKER_USERNAME/$BACKEND_IMAGE:latest

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            docker stop webide-backend || true
            docker rm webide-backend || true

            # âœ… í™˜ê²½ë³€ìˆ˜ í™•ì¸ ë¡œê·¸ ì¶œë ¥
            echo "âœ… .env íŒŒì¼ ì ìš© ì™„ë£Œ"


            # ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            docker run -d --name webide-backend \
              --env-file /home/ubuntu/web-ide-be/.env \
              -p 8080:8080 \
              $DOCKER_USERNAME/$BACKEND_IMAGE:latest

            # í…œí”Œë¦¿ ì´ë¯¸ì§€ ë¯¸ë¦¬ pull (ì„ íƒ ì‚¬í•­, ìë™ pullë„ ë˜ê¸´ í•¨)
            docker pull $DOCKER_USERNAME/java-template:17 || true
            docker pull $DOCKER_USERNAME/python-template:3.11 || true

