name: Web IDE Backend CI

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ main, develop ]  # main ë˜ëŠ” develop ë¸Œëœì¹˜ë¡œì˜ PR ìƒì„±/ìˆ˜ì • ì‹œ ì‹¤í–‰ë¨

jobs:
  test:
    runs-on: ubuntu-latest  # GitHub ì œê³µ ìš°ë¶„íˆ¬ í™˜ê²½ì—ì„œ ì‹¤í–‰

    services:
      mysql:
        image: mysql:8.0
        ports:
          - 3306:3306
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: webide
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    env:
      DB_HOST: 127.0.0.1
      DB_NAME: webide
      DB_USER_NAME: root
      DB_USER_PASSWORD: root


    steps:
      #  GitHub ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ”„ Checkout source code
        uses: actions/checkout@v3  # PR ë¸Œëœì¹˜ì˜ ì†ŒìŠ¤ì½”ë“œë¥¼ ê°€ì ¸ì˜´

      #  JDK 21 ì„¤ì¹˜
      - name: â˜• JDK 21 ì„¤ì¹˜
        uses: actions/setup-java@v3
        with:
          java-version: '21'       # í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í•˜ëŠ” Java ë²„ì „
          distribution: 'temurin'  # Temurinì€ OpenJDK ë°°í¬íŒ ì¤‘ í•˜ë‚˜

      - name: ğŸ“„ Create .env file for CI
        run: |
          echo "DB_HOST=127.0.0.1" >> .env
          echo "DB_NAME=webide" >> .env
          echo "DB_USER_NAME=root" >> .env
          echo "DB_USER_PASSWORD=root" >> .env
          echo "DB_PORT=3308" >> .env
          echo "JWT_SECRET=mytestsecret" >> .env
          echo "JWT_EXPIRATION=3600000" >> .env
          echo "SPRING_PROFILES_ACTIVE=local" >> .env
          echo "MAIL_USERNAME=test@example.com" >> .env
          echo "MAIL_PASSWORD=secret" >> .env
          echo "MAIL_FROM=test@example.com" >> .env
          echo "LIVEBLOCKS_ROOM_SALT=dummy-salt-for-test" >> .env
          echo "LIVEBLOCKS_SECRET_KEY=dummy-key-for-test" >> .env

        # í™˜ê²½ ë³€ìˆ˜ export (Spring Bootê°€ ì¸ì‹ ê°€ëŠ¥í•˜ê²Œ)
      - name: ğŸŒ± Export .env values to environment
        run: |
          set -a
          source .env
          set +a


      - name: â³ Wait for MySQL to be healthy
        run: |
          for i in {1..10}; do
            nc -z 127.0.0.1 3306 && echo "MySQL is up!" && exit 0
            echo "Waiting for MySQL..."
            sleep 3
          done
          echo "MySQL did not start in time" && exit 1

      #  Gradle ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: ğŸ§ª Gradle Build & Test
        run: ./gradlew clean build       # compile, test ë“± ì „ì²´ ë¹Œë“œ ìˆ˜í–‰
